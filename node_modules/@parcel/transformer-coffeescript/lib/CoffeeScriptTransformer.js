"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _plugin = require("@parcel/plugin");

var _sourceMap = _interopRequireDefault(require("@parcel/source-map"));

var _coffeescript = _interopRequireDefault(require("coffeescript"));

var _utils = require("@parcel/utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var _default = new _plugin.Transformer({
  async transform({
    asset,
    options
  }) {
    let sourceFileName = (0, _utils.relativeUrl)(options.projectRoot, asset.filePath);
    asset.type = 'js';

    let output = _coffeescript.default.compile((await asset.getCode()), {
      filename: sourceFileName,
      sourceMap: options.sourceMaps
    }); // return from compile is based on sourceMaps option


    if (options.sourceMaps) {
      let map = null;

      if (output.v3SourceMap) {
        map = new _sourceMap.default();
        map.addRawMappings(JSON.parse(output.v3SourceMap));
      }

      asset.setCode(output.js);
      asset.setMap(map);
    } else {
      asset.setCode(output);
    }

    return [asset];
  }

});

exports.default = _default;