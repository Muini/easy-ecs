"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _plugin = require("@parcel/plugin");

var _posthtmlParser = _interopRequireDefault(require("posthtml-parser"));

var _nullthrows = _interopRequireDefault(require("nullthrows"));

var _posthtmlRender = _interopRequireDefault(require("posthtml-render"));

var _semver = _interopRequireDefault(require("semver"));

var _dependencies = _interopRequireDefault(require("./dependencies"));

var _inline = _interopRequireDefault(require("./inline"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var _default = new _plugin.Transformer({
  canReuseAST({
    ast
  }) {
    return ast.type === 'posthtml' && _semver.default.satisfies(ast.version, '^0.4.0');
  },

  async parse({
    asset
  }) {
    return {
      type: 'posthtml',
      version: '0.4.1',
      program: (0, _posthtmlParser.default)((await asset.getCode()), {
        lowerCaseAttributeNames: true
      })
    };
  },

  async transform({
    asset
  }) {
    // Handle .htm
    asset.type = 'html';
    let ast = (0, _nullthrows.default)((await asset.getAST()));
    (0, _dependencies.default)(asset, ast);
    return [asset, ...(0, _inline.default)(asset, ast)];
  },

  generate({
    ast
  }) {
    return {
      content: (0, _posthtmlRender.default)(ast.program)
    };
  }

});

exports.default = _default;