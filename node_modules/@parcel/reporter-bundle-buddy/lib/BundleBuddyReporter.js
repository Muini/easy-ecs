"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _plugin = require("@parcel/plugin");

var _path = _interopRequireDefault(require("path"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var _default = new _plugin.Reporter({
  async report({
    event,
    options
  }) {
    if (event.type !== 'buildSuccess' || process.env.BUNDLE_BUDDY == null) {
      return;
    }

    let bundlesByTarget = new Map();

    for (let bundle of event.bundleGraph.getBundles()) {
      if (!bundle.isInline) {
        let bundles = bundlesByTarget.get(bundle.target.distDir);

        if (!bundles) {
          bundles = [];
          bundlesByTarget.set(bundle.target.distDir, bundles);
        }

        bundles.push(bundle);
      }
    }

    for (let [targetDir, bundles] of bundlesByTarget) {
      let out = [];

      for (let bundle of bundles) {
        bundle.traverseAssets(asset => {
          let deps = event.bundleGraph.getDependencies(asset);

          for (let dep of deps) {
            let resolved = event.bundleGraph.getDependencyResolution(dep);

            if (!resolved) {
              continue;
            }

            out.push({
              source: _path.default.relative(options.projectRoot, asset.filePath),
              target: _path.default.relative(options.projectRoot, resolved.filePath)
            });
          }
        });
      }

      await options.outputFS.writeFile(`${targetDir}/bundle-buddy.json`, JSON.stringify(out));
    }
  }

});

exports.default = _default;