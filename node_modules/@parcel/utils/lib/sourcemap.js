"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.matchSourceMappingURL = matchSourceMappingURL;
exports.loadSourceMapUrl = loadSourceMapUrl;
exports.loadSourceMap = loadSourceMap;

var _sourceMap = _interopRequireDefault(require("@parcel/source-map"));

var _path = _interopRequireDefault(require("path"));

var _path2 = require("./path");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const SOURCEMAP_RE = /(?:\/\*|\/\/)\s*[@#]\s*sourceMappingURL\s*=\s*([^\s*]+)(?:\s*\*\/)?\s*$/;
const DATA_URL_RE = /^data:[^;]+(?:;charset=[^;]+)?;base64,(.*)/;

function matchSourceMappingURL(contents) {
  return contents.match(SOURCEMAP_RE);
}

async function loadSourceMapUrl(fs, filename, contents) {
  let match = matchSourceMappingURL(contents);

  if (match) {
    let url = match[1].trim();
    let dataURLMatch = url.match(DATA_URL_RE);
    filename = dataURLMatch ? filename : _path.default.join(_path.default.dirname(filename), url);
    return {
      url,
      filename,
      map: JSON.parse(dataURLMatch ? Buffer.from(dataURLMatch[1], 'base64').toString() : await fs.readFile(filename, 'utf8'))
    };
  }
}

async function loadSourceMap(filename, contents, options) {
  let foundMap = await loadSourceMapUrl(options.fs, filename, contents);

  if (foundMap) {
    let mapSourceRoot = _path.default.dirname(filename);

    if (foundMap.map.sourceRoot && !(0, _path2.normalizeSeparators)(foundMap.map.sourceRoot).startsWith('/')) {
      mapSourceRoot = _path.default.join(mapSourceRoot, foundMap.map.sourceRoot);
    }

    let sourcemapInstance = new _sourceMap.default();
    sourcemapInstance.addRawMappings({ ...foundMap.map,
      sources: foundMap.map.sources.map(s => {
        return _path.default.relative(options.projectRoot, _path.default.join(mapSourceRoot, s));
      })
    });
    return sourcemapInstance;
  }
}